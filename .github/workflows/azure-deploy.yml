name: ðŸš€ Deploy to Azure

on:
  push:
    branches:
      - main
  workflow_dispatch:  # Allow manual deployment
    inputs:
      force_deploy:
        description: 'Force deployment without waiting for tests'
        required: false
        default: false
        type: boolean

env:
  AZURE_WEBAPP_NAME: salonis-mock-trading-app
  AZURE_WEBAPP_PACKAGE_PATH: '.'
  NODE_VERSION: '18'
  PYTHON_VERSION: '3.11'

jobs:
  check-tests:
    name: ðŸ” Check Test Status
    runs-on: ubuntu-latest
    if: github.event.inputs.force_deploy != 'true'
    outputs:
      should_deploy: ${{ steps.check.outputs.should_deploy }}
    
    steps:
    - name: ðŸ“¥ Checkout Code
      uses: actions/checkout@v4
    
    - name: ðŸ” Check Latest Test Run
      id: check
      uses: actions/github-script@v6
      with:
        script: |
          const { owner, repo } = context.repo;
          const sha = context.sha;
          
          try {
            // Get the latest test suite workflow run for this commit
            const runs = await github.rest.actions.listWorkflowRuns({
              owner,
              repo,
              workflow_id: 'test-suite.yml',
              head_sha: sha,
              per_page: 1
            });
            
            if (runs.data.workflow_runs.length === 0) {
              console.log('No test runs found for this commit');
              core.setOutput('should_deploy', 'false');
              return;
            }
            
            const testRun = runs.data.workflow_runs[0];
            console.log(`Latest test run: ${testRun.status} - ${testRun.conclusion}`);
            
            if (testRun.conclusion === 'success') {
              console.log('âœ… Tests passed, proceeding with deployment');
              core.setOutput('should_deploy', 'true');
            } else {
              console.log('âŒ Tests failed or not completed');
              core.setOutput('should_deploy', 'false');
            }
          } catch (error) {
            console.log('Error checking test status:', error.message);
            core.setOutput('should_deploy', 'false');
          }

  build-and-deploy:
    name: ðŸ—ï¸ Build & Deploy
    runs-on: ubuntu-latest
    needs: [check-tests]
    if: |
      always() && 
      (needs.check-tests.outputs.should_deploy == 'true' || 
       github.event.inputs.force_deploy == 'true' ||
       needs.check-tests.result == 'skipped')

    steps:
    - name: ðŸ“¥ Checkout Code
      uses: actions/checkout@v4

    - name: ðŸ Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'

    - name: ðŸ“¦ Set up Node
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json

    - name: ðŸ“¦ Install Python Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r backend/requirements.txt

    - name: ðŸ”§ Pre-deployment Health Check
      run: |
        cd backend
        python -c "
        import django
        import os
        os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'mock_trading.settings')
        os.environ.setdefault('SECRET_KEY', 'temp-key-for-check')
        os.environ.setdefault('DEBUG', 'False')
        django.setup()
        
        from django.core.management import execute_from_command_line
        print('âœ“ Django configuration is valid')
        
        # Test critical imports
        from market.models import Market, SpreadBid, Trade
        from accounts.models import UserProfile
        print('âœ“ All models import successfully')
        
        from market.views import MarketViewSet
        from accounts.views import UserProfileView
        print('âœ“ All views import successfully')
        "

    - name: ðŸ—ï¸ Build Production Frontend
      run: |
        cd frontend
        npm ci --production --prefer-offline --no-audit
        CI=false NODE_ENV=production npm run build
        echo "âœ“ Frontend build completed"

    - name: ðŸ“ Prepare Django Static Files
      run: |
        cd backend
        mkdir -p static templates
        cp -r ../frontend/build/* static/
        cp ../frontend/build/index.html templates/
        echo "âœ“ Static files prepared"

    - name: ðŸ§¹ Clean Build Artifacts
      run: |
        # Remove node_modules to reduce deployment size
        rm -rf frontend/node_modules
        rm -rf frontend/.git
        
        # Remove Python cache files
        find backend -name "*.pyc" -delete
        find backend -name "__pycache__" -type d -exec rm -rf {} + 2>/dev/null || true
        
        # Remove development files
        rm -f backend/db.sqlite3
        rm -rf backend/.pytest_cache
        
        echo "âœ“ Build artifacts cleaned"

    - name: ðŸ“¦ Create Deployment Package
      run: |
        echo "=== Deployment Package Contents ===" 
        echo "Backend files:"
        find backend -type f -name "*.py" | head -10
        echo "Static files:"
        find backend/static -type f | head -5
        echo "Templates:"
        find backend/templates -type f
        echo "Requirements:"
        cat backend/requirements.txt | head -5
        echo "================================="

    - name: ðŸš€ Deploy to Azure Web App
      uses: azure/webapps-deploy@v2
      with:
        app-name: ${{ env.AZURE_WEBAPP_NAME }}
        publish-profile: ${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE }}
        package: backend

    - name: â±ï¸ Wait for Deployment
      run: |
        echo "â±ï¸ Waiting for deployment to stabilize..."
        sleep 30

    - name: ðŸ” Post-Deployment Health Check
      run: |
        echo "ðŸ” Testing deployment health..."
        
        max_attempts=10
        attempt=1
        
        while [ $attempt -le $max_attempts ]; do
          echo "Attempt $attempt/$max_attempts..."
          
          # Test basic connectivity
          if curl -f -s -o /dev/null --max-time 30 "https://${{ env.AZURE_WEBAPP_NAME }}.azurewebsites.net/"; then
            echo "âœ… App is responding!"
            
            # Test admin login (optional - may fail if admin doesn't exist yet)
            echo "Testing admin API access..."
            curl -s -X POST "https://${{ env.AZURE_WEBAPP_NAME }}.azurewebsites.net/api/auth/login/" \
              -H "Content-Type: application/json" \
              -d '{"username": "admin", "password": "admin123"}' \
              && echo "âœ… Admin API accessible" \
              || echo "â„¹ï¸ Admin API test failed (may be normal for fresh deployment)"
            
            break
          else
            echo "â³ App not ready yet..."
            if [ $attempt -eq $max_attempts ]; then
              echo "âŒ Deployment health check failed"
              exit 1
            fi
            sleep 10
          fi
          
          attempt=$((attempt + 1))
        done

    - name: ðŸŽ‰ Deployment Success
      run: |
        echo "
        â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
        â•‘                    ðŸŽ‰ DEPLOYMENT SUCCESSFUL! ðŸŽ‰                  â•‘
        â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
        â•‘                                                                  â•‘
        â•‘  ðŸŒ Application URL:                                              â•‘
        â•‘     https://${{ env.AZURE_WEBAPP_NAME }}.azurewebsites.net                       â•‘
        â•‘                                                                  â•‘
        â•‘  ðŸ”— Admin Panel:                                                  â•‘
        â•‘     https://${{ env.AZURE_WEBAPP_NAME }}.azurewebsites.net/admin/                â•‘
        â•‘                                                                  â•‘
        â•‘  ðŸ“š API Documentation:                                            â•‘
        â•‘     https://${{ env.AZURE_WEBAPP_NAME }}.azurewebsites.net/api/                  â•‘
        â•‘                                                                  â•‘
        â•‘  âœ… Features Deployed:                                            â•‘
        â•‘     â€¢ Spread Bidding (no upper limit)                           â•‘
        â•‘     â€¢ Market Creation & Management                               â•‘
        â•‘     â€¢ User Authentication & Trading                              â•‘
        â•‘     â€¢ Real-time Market Updates                                   â•‘
        â•‘     â€¢ Admin Dashboard                                            â•‘
        â•‘                                                                  â•‘
        â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        " >> $GITHUB_STEP_SUMMARY

  post-deployment-tests:
    name: ðŸ§ª Post-Deployment Tests
    runs-on: ubuntu-latest
    needs: build-and-deploy
    if: success()

    steps:
    - name: ðŸ“¥ Checkout Code
      uses: actions/checkout@v4

    - name: ðŸ Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: ðŸ“¦ Install Test Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests

    - name: ðŸŒ Test Production API
      run: |
        echo "ðŸ§ª Running production API tests..."
        python test_trading_api.py
      env:
        API_BASE_URL: https://${{ env.AZURE_WEBAPP_NAME }}.azurewebsites.net

    - name: ðŸ“Š Generate Deployment Report
      if: always()
      run: |
        echo "# ðŸš€ Deployment Report" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Deployment Date:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
        echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Application URL:** https://${{ env.AZURE_WEBAPP_NAME }}.azurewebsites.net" >> $GITHUB_STEP_SUMMARY