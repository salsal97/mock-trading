name: Comprehensive Test Suite

on:
  push:
    branches: [ main, dev, feature/* ]
  pull_request:
    branches: [ main, dev ]
  workflow_dispatch:  # Allow manual triggering

env:
  NODE_VERSION: '18'
  PYTHON_VERSION: '3.11'

jobs:
  backend-tests:
    name: üêç Backend Tests
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:13
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_USER: postgres
          POSTGRES_DB: test_mock_trading
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
    - name: üì• Checkout Code
      uses: actions/checkout@v4

    - name: üêç Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'

    - name: üì¶ Install Python Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r backend/requirements.txt

    - name: üîß Setup Django Environment
      run: |
        cd backend
        python manage.py makemigrations --check --dry-run --verbosity=2
        python manage.py migrate --verbosity=2
      env:
        SECRET_KEY: test-secret-key-for-github-actions
        DB_NAME: test_mock_trading
        DB_USER: postgres
        DB_PASSWORD: postgres
        DB_HOST: localhost
        DB_PORT: 5432
        DEBUG: True

    - name: üß™ Run Django Unit Tests
      run: |
        cd backend
        python manage.py test --verbosity=2 --parallel
      env:
        SECRET_KEY: test-secret-key-for-github-actions
        DB_NAME: test_mock_trading
        DB_USER: postgres
        DB_PASSWORD: postgres
        DB_HOST: localhost
        DB_PORT: 5432
        DEBUG: True

    - name: üèóÔ∏è Test Database Models
      run: |
        cd backend
        # Ensure fresh database state
        python manage.py migrate --run-syncdb
        python manage.py flush --noinput || true
        python manage.py shell << 'EOF'
        from django.contrib.auth.models import User
        from market.models import Market, SpreadBid, Trade
        from accounts.models import UserProfile
        from django.utils import timezone
        from datetime import timedelta
        import uuid
        
        print("=== Testing Model Creation ===")
        
        # Use unique username to avoid conflicts
        username = f"testuser_{uuid.uuid4().hex[:8]}"
        
        # Test user creation with get_or_create for safety
        user, created = User.objects.get_or_create(
            username=username,
            defaults={
                'email': f'{username}@example.com',
                'first_name': 'Test',
                'last_name': 'User'
            }
        )
        if created:
            user.set_password('testpass')
            user.save()
        
        # Test profile creation
        profile, created = UserProfile.objects.get_or_create(
            user=user,
            defaults={'balance': 1000.0}
        )
        print(f"‚úì Created user: {user.username} (new: {created})")
        
        # Test market creation
        now = timezone.now()
        market = Market.objects.create(
            premise=f"Test market premise {uuid.uuid4().hex[:8]}",
            unit_price=1.0,
            initial_spread=20,
            spread_bidding_open=now - timedelta(hours=1),
            spread_bidding_close_trading_open=now + timedelta(hours=1),
            trading_close=now + timedelta(hours=2),
            created_by=user
        )
        print(f"‚úì Created market: {market.id}")
        
        # Test spread bid creation
        bid = SpreadBid.objects.create(
            market=market,
            user=user,
            spread_low=40.0,
            spread_high=60.0
        )
        print(f"‚úì Created spread bid: {bid.spread_width} width")
        
        print("=== All model tests passed ===")
        EOF
      env:
        SECRET_KEY: test-secret-key-for-github-actions
        DB_NAME: test_mock_trading
        DB_USER: postgres
        DB_PASSWORD: postgres
        DB_HOST: localhost
        DB_PORT: 5432
        DEBUG: True

  frontend-tests:
    name: ‚öõÔ∏è Frontend Tests
    runs-on: ubuntu-latest

    steps:
    - name: üì• Checkout Code
      uses: actions/checkout@v4

    - name: üì¶ Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json

    - name: üì¶ Install Frontend Dependencies
      run: |
        cd frontend
        npm ci --prefer-offline --no-audit

    - name: üß™ Run Frontend Tests
      run: |
        cd frontend
        npm test -- --coverage --watchAll=false --testTimeout=30000
      env:
        CI: true

    - name: üèóÔ∏è Test Frontend Build
      run: |
        cd frontend
        CI=false npm run build
        echo "‚úì Frontend build successful"

    - name: üìä Upload Coverage
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: frontend-coverage
        path: frontend/coverage/
        retention-days: 7

  integration-tests:
    name: üîó Integration Tests
    runs-on: ubuntu-latest
    needs: [backend-tests, frontend-tests]
    
    services:
      postgres:
        image: postgres:13
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_USER: postgres
          POSTGRES_DB: test_integration_db
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
    - name: üì• Checkout Code
      uses: actions/checkout@v4

    - name: üêç Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: üì¶ Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json

    - name: üì¶ Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r backend/requirements.txt
        pip install requests  # For API testing
        cd frontend
        npm ci --prefer-offline --no-audit

    - name: üèóÔ∏è Build Complete Application
      run: |
        cd frontend
        CI=false NODE_ENV=production npm run build
        cd ../backend
        python manage.py makemigrations
        python manage.py migrate
        mkdir -p static templates
        cp -r ../frontend/build/* static/
        cp ../frontend/build/index.html templates/
        python manage.py collectstatic --noinput
      env:
        SECRET_KEY: test-secret-key-for-github-actions
        DB_NAME: test_integration_db
        DB_USER: postgres
        DB_PASSWORD: postgres
        DB_HOST: localhost
        DB_PORT: 5432
        DEBUG: True

    - name: üë• Create Test Users
      run: |
        cd backend
        python manage.py shell << 'EOF'
        from django.contrib.auth.models import User
        from accounts.models import UserProfile
        
        # Create admin user
        admin_user, created = User.objects.get_or_create(
            username='admin',
            defaults={
                'email': 'admin@test.com',
                'is_staff': True,
                'is_superuser': True
            }
        )
        if created:
            admin_user.set_password('admin123')
            admin_user.save()
            UserProfile.objects.get_or_create(
                user=admin_user,
                defaults={'balance': 10000.0}
            )
            print(f"Created admin user: {admin_user.username}")
        
        # Create test users for trading
        test_users = ['bidder1', 'bidder2', 'bidder3', 'trader']
        for username in test_users:
            user, created = User.objects.get_or_create(
                username=username,
                defaults={
                    'email': f'{username}@test.com',
                    'first_name': 'Test',
                    'last_name': 'User'
                }
            )
            if created:
                user.set_password('testpass123')
                user.save()
                UserProfile.objects.get_or_create(
                    user=user,
                    defaults={'balance': 1000.0}
                )
                print(f"Created test user: {user.username}")
        
        print("User setup completed successfully!")
        EOF
      env:
        SECRET_KEY: test-secret-key-for-github-actions
        DB_NAME: test_integration_db
        DB_USER: postgres
        DB_PASSWORD: postgres
        DB_HOST: localhost
        DB_PORT: 5432
        DEBUG: True

    - name: üöÄ Start Django Test Server
      run: |
        cd backend
        python manage.py runserver 8000 &
        SERVER_PID=$!
        echo "SERVER_PID=$SERVER_PID" >> $GITHUB_ENV
        
        # Wait for server to start
        for i in {1..30}; do
          if curl -s http://localhost:8000/ > /dev/null; then
            echo "‚úì Django server started successfully"
            break
          fi
          echo "Waiting for server... ($i/30)"
          sleep 2
        done
      env:
        SECRET_KEY: test-secret-key-for-github-actions
        DB_NAME: test_integration_db
        DB_USER: postgres
        DB_PASSWORD: postgres
        DB_HOST: localhost
        DB_PORT: 5432
        DEBUG: True

    - name: üîç Test Server Health
      run: |
        echo "Testing basic server response..."
        curl -f -s -o /dev/null http://localhost:8000/ || echo "‚ö†Ô∏è Main page not accessible"
        
        echo "Testing API authentication..."
        response=$(curl -s -X POST http://localhost:8000/api/auth/login/ \
          -H "Content-Type: application/json" \
          -d '{"username": "admin", "password": "admin123"}')
        echo "Login response: $response"

    - name: üß™ Run Comprehensive API Tests
      run: |
        echo "=== Running Comprehensive API Tests ==="
        python test_trading_api.py
      env:
        API_BASE_URL: http://localhost:8000

    - name: üéØ Run Spread Bidding Model Tests
      run: |
        cd backend
        python manage.py shell << 'EOF'
        from django.contrib.auth.models import User
        from market.models import Market, SpreadBid
        from datetime import timedelta
        from django.utils import timezone
        
        print("=== Spread Bidding Model Tests ===")
        
        # Create market for testing
        admin_user = User.objects.get(username='admin')
        now = timezone.now()
        
        market = Market.objects.create(
            premise="CI Test Market for Spread Bidding",
            unit_price=1.0,
            initial_spread=30,
            spread_bidding_open=now - timedelta(hours=1),
            spread_bidding_close_trading_open=now + timedelta(hours=1),
            trading_close=now + timedelta(hours=3),
            created_by=admin_user
        )
        print(f"‚úì Created test market: {market.id}")
        
        # Test spread bids
        test_users = User.objects.filter(username__startswith='bidder')
        
        bid1 = SpreadBid.objects.create(
            market=market,
            user=test_users[0],
            spread_low=40.0,
            spread_high=60.0
        )
        print(f"‚úì Bid 1: {bid1.spread_low}-{bid1.spread_high} (width: {bid1.spread_width})")
        
        bid2 = SpreadBid.objects.create(
            market=market,
            user=test_users[1],
            spread_low=42.0,
            spread_high=58.0
        )
        print(f"‚úì Bid 2: {bid2.spread_low}-{bid2.spread_high} (width: {bid2.spread_width})")
        
        # Test high values (no upper limit)
        bid3 = SpreadBid.objects.create(
            market=market,
            user=test_users[2],
            spread_low=200.0,
            spread_high=300.0
        )
        print(f"‚úì High value bid: {bid3.spread_low}-{bid3.spread_high} (width: {bid3.spread_width})")
        
        # Check best bid
        best_bid = market.best_spread_bid
        print(f"‚úì Best bid: {best_bid.user.username} with width {best_bid.spread_width}")
        
        # Test market activation
        result = market.auto_activate_market()
        print(f"‚úì Auto-activation: {result['success']} - {result['reason']}")
        
        if result['success']:
            market.refresh_from_db()
            print(f"‚úì Final status: {market.status}")
            print(f"‚úì Market maker: {market.market_maker.username}")
            print(f"‚úì Final spread: {market.final_spread_low} - {market.final_spread_high}")
        
        print("=== All spread bidding tests passed! ===")
        EOF
      env:
        SECRET_KEY: test-secret-key-for-github-actions
        DB_NAME: test_integration_db
        DB_USER: postgres
        DB_PASSWORD: postgres
        DB_HOST: localhost
        DB_PORT: 5432
        DEBUG: True

    - name: üßπ Cleanup
      if: always()
      run: |
        if [ ! -z "$SERVER_PID" ]; then
          kill $SERVER_PID || true
        fi

    - name: üìä Upload Test Artifacts
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: integration-test-results
        path: |
          backend/db.sqlite3
          backend/logs/
        retention-days: 7

  local-tests:
    name: üè† Local Environment Tests
    runs-on: ubuntu-latest
    needs: [backend-tests]

    steps:
    - name: üì• Checkout Code
      uses: actions/checkout@v4

    - name: üêç Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: üì¶ Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r backend/requirements.txt

    - name: üß™ Run Local Tests
      run: |
        export DJANGO_SETTINGS_MODULE=mock_trading.settings
        export SECRET_KEY=test-local-key
        export DEBUG=True
        python test_local.py

  summary:
    name: üìã Test Summary
    runs-on: ubuntu-latest
    needs: [backend-tests, frontend-tests, integration-tests, local-tests]
    if: always()

    steps:
    - name: üìä Generate Test Report
      run: |
        echo "# üß™ Test Suite Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Test Job | Status | Details |" >> $GITHUB_STEP_SUMMARY
        echo "|----------|--------|---------|" >> $GITHUB_STEP_SUMMARY
        echo "| üêç Backend Tests | ${{ needs.backend-tests.result }} | Django unit tests, migrations, models |" >> $GITHUB_STEP_SUMMARY
        echo "| ‚öõÔ∏è Frontend Tests | ${{ needs.frontend-tests.result }} | React tests, build validation, coverage |" >> $GITHUB_STEP_SUMMARY
        echo "| üîó Integration Tests | ${{ needs.integration-tests.result }} | Full-stack API tests, spread bidding |" >> $GITHUB_STEP_SUMMARY
        echo "| üè† Local Tests | ${{ needs.local-tests.result }} | Standalone logic validation |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [[ "${{ needs.backend-tests.result }}" == "success" && "${{ needs.frontend-tests.result }}" == "success" && "${{ needs.integration-tests.result }}" == "success" && "${{ needs.local-tests.result }}" == "success" ]]; then
          echo "## ‚úÖ All Tests Passed!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "üéâ The application is ready for deployment!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Features Validated:" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Spread bidding mechanics (no upper limit)" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Market creation and activation" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ User authentication and trading" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Database operations and migrations" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Frontend build and functionality" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ API integration and validation" >> $GITHUB_STEP_SUMMARY
          exit 0
        else
          echo "## ‚ùå Some Tests Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Please check the individual job results above for details." >> $GITHUB_STEP_SUMMARY
          exit 1
        fi 